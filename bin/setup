#!/usr/bin/env bash
#
# bin/setup - First-time setup for NoobBook development environment
#
# This script:
# 1. Creates Python virtual environment
# 2. Installs backend dependencies
# 3. Installs frontend dependencies
# 4. Creates .env from template if needed
# 5. Installs Playwright browsers
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

# Get the root directory
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BACKEND_DIR="$ROOT_DIR/backend"
FRONTEND_DIR="$ROOT_DIR/frontend"

echo -e "${BOLD}${CYAN}"
echo "  _   _             _     ____              _    "
echo " | \ | | ___   ___ | |__ | __ )  ___   ___ | | __"
echo " |  \| |/ _ \ / _ \| '_ \|  _ \ / _ \ / _ \| |/ /"
echo " | |\  | (_) | (_) | |_) | |_) | (_) | (_) |   < "
echo " |_| \_|\___/ \___/|_.__/|____/ \___/ \___/|_|\_\\"
echo -e "${NC}"
echo -e "${BOLD}First-Time Setup${NC}"
echo ""

# Check system dependencies
echo -e "${BLUE}Checking system dependencies...${NC}"

check_command() {
    if command -v "$1" &> /dev/null; then
        echo -e "  ${GREEN}✓${NC} $1"
        return 0
    else
        echo -e "  ${RED}✗${NC} $1 - ${YELLOW}Please install: $2${NC}"
        return 1
    fi
}

MISSING_DEPS=false

check_command "python3" "brew install python3" || MISSING_DEPS=true
check_command "node" "brew install node" || MISSING_DEPS=true
check_command "npm" "brew install node" || MISSING_DEPS=true

# Optional but recommended
if ! command -v libreoffice &> /dev/null; then
    echo -e "  ${YELLOW}⚠${NC} libreoffice - ${CYAN}Optional: brew install libreoffice${NC} (for DOCX/PPTX)"
fi

if ! command -v ffmpeg &> /dev/null; then
    echo -e "  ${YELLOW}⚠${NC} ffmpeg - ${CYAN}Optional: brew install ffmpeg${NC} (for audio)"
fi

if [ "$MISSING_DEPS" = true ]; then
    echo ""
    echo -e "${RED}Please install missing dependencies and run again${NC}"
    exit 1
fi

echo ""

# Backend setup
echo -e "${BLUE}Setting up backend...${NC}"

# Create virtual environment
if [ ! -d "$BACKEND_DIR/venv" ]; then
    echo "  Creating Python virtual environment..."
    (cd "$BACKEND_DIR" && python3 -m venv venv)
    echo -e "  ${GREEN}✓${NC} Virtual environment created"
else
    echo -e "  ${GREEN}✓${NC} Virtual environment exists"
fi

# Install Python dependencies
echo "  Installing Python packages (this may take a minute)..."
(cd "$BACKEND_DIR" && source venv/bin/activate && pip install -r requirements.txt --quiet)
echo -e "  ${GREEN}✓${NC} Python packages installed"

# Create .env if needed
if [ ! -f "$BACKEND_DIR/.env" ]; then
    if [ -f "$BACKEND_DIR/.env.template" ]; then
        cp "$BACKEND_DIR/.env.template" "$BACKEND_DIR/.env"
        echo -e "  ${GREEN}✓${NC} Created .env from template"
        echo -e "  ${YELLOW}!${NC} Remember to add your API keys to backend/.env"
    fi
else
    echo -e "  ${GREEN}✓${NC} .env file exists"
fi

echo ""

# Frontend setup
echo -e "${BLUE}Setting up frontend...${NC}"

# Install npm packages
echo "  Installing npm packages..."
(cd "$FRONTEND_DIR" && npm install --silent)
echo -e "  ${GREEN}✓${NC} npm packages installed"

echo ""

# Install Playwright browsers (optional)
echo -e "${BLUE}Installing Playwright browsers (for web scraping)...${NC}"
(cd "$FRONTEND_DIR" && npx playwright install chromium --quiet 2>/dev/null) || echo -e "  ${YELLOW}⚠${NC} Playwright install skipped (run manually if needed)"
echo -e "  ${GREEN}✓${NC} Playwright setup complete"

echo ""
echo -e "${BOLD}${GREEN}Setup complete!${NC}"
echo ""
echo -e "Next steps:"
echo -e "  1. Add your API keys to ${CYAN}backend/.env${NC}:"
echo -e "     ${CYAN}ANTHROPIC_API_KEY=sk-ant-...${NC}"
echo -e "     ${CYAN}OPENAI_API_KEY=sk-...${NC}"
echo -e "     ${CYAN}PINECONE_API_KEY=...${NC}"
echo -e "     ${CYAN}PINECONE_INDEX_NAME=...${NC}"
echo ""
echo -e "  2. Start the development servers:"
echo -e "     ${CYAN}bin/dev${NC}"
echo ""
