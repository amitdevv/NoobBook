# NoobBook Docker Compose
# Builds and runs the NoobBook backend, frontend, and database migration.
# Supabase must be started first via docker/supabase/docker-compose.yml.

services:
  # --- Backend (Flask + SocketIO) ---
  backend:
    build: ./backend
    container_name: noobbook-backend
    restart: unless-stopped
    ports:
      - "5001:5001"
    env_file:
      - ./docker/.env
    environment:
      - FLASK_ENV=production
      - PORT=5001
      - SUPABASE_URL=http://supabase-kong:8000
      - ALLOWED_ORIGINS=http://localhost
    volumes:
      - backend-data:/app/data
    networks:
      - noobbook-network
    depends_on:
      migrate:
        condition: service_completed_successfully

  # --- Frontend (nginx serving React build) ---
  frontend:
    build: ./frontend
    container_name: noobbook-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    networks:
      - noobbook-network
    depends_on:
      - backend

  # --- Database migration (runs once, then exits) ---
  migrate:
    image: postgres:16-alpine
    container_name: noobbook-migrate
    restart: "no"
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD:-your-super-secret-and-long-postgres-password}
    volumes:
      - ./backend/supabase/init.sql:/init.sql:ro
    entrypoint: >
      sh -c '
        echo "Waiting for Supabase database..."
        until pg_isready -h supabase-db -p 5432 -U supabase_admin 2>/dev/null; do
          sleep 2
        done
        echo "Running database migrations..."
        PGPASSWORD=$${PGPASSWORD} psql -h supabase-db -p 5432 -U supabase_admin -d postgres -f /init.sql
        echo "Migration complete."
      '
    networks:
      - noobbook-network

volumes:
  backend-data:
    name: noobbook-backend-data

networks:
  noobbook-network:
    external: true
    name: noobbook-network
