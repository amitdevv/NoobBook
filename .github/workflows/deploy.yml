# Auto-deploy NoobBook to AWS EC2
# Triggers on push to develop branch.
# SSHs into EC2, pulls latest code, runs migrations, rebuilds app containers.
# Supabase containers are NOT touched — only backend + frontend rebuild.

name: Deploy to AWS EC2

on:
  push:
    branches:
      - develop

  # Allow manual trigger from GitHub UI
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    # Only run on TeacherOp's repo — skip on forks
    if: github.repository == 'TeacherOp/NoobBook'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          timeout: 600s
          script: |
            set -e

            echo "=== Navigating to project ==="
            cd ~/NoobBook

            echo "=== Pulling latest code ==="
            git fetch origin develop
            git checkout develop
            git pull origin develop

            # Verify pull succeeded by checking HEAD matches remote
            LOCAL_SHA=$(git rev-parse HEAD)
            REMOTE_SHA=$(git rev-parse origin/develop)
            if [ "$LOCAL_SHA" != "$REMOTE_SHA" ]; then
              echo "FAIL: git pull incomplete (local=$LOCAL_SHA remote=$REMOTE_SHA)"
              exit 1
            fi
            echo "Code verified at $LOCAL_SHA"

            echo "=== Running migrations ==="
            # Runs init.sql (if fresh DB) + applies any new migration files.
            # Safe to run every deploy — idempotent (skips already-applied migrations).
            docker compose up migrate --build

            echo "=== Rebuilding app containers ==="
            # Build separately from start so --no-cache works if ever needed manually.
            # GIT_SHA build-arg stamps the image and busts Docker cache every deploy.
            docker compose build --build-arg GIT_SHA=$LOCAL_SHA backend frontend
            # --force-recreate ensures containers are recreated even if Docker thinks
            # the image hasn't changed. Only backend + frontend — Supabase stays untouched.
            docker compose up -d --force-recreate --no-deps backend frontend

            echo "=== Waiting for backend to be ready ==="
            # Poll backend health — warning only, not fatal.
            # By this point docker compose has already rebuilt and started containers.
            # A timeout here just means the backend is slow to start (heavy imports),
            # not that the deploy failed.
            BACKEND_READY=false
            for i in $(seq 1 40); do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/v1/projects 2>/dev/null)
              if echo "$HTTP_CODE" | grep -qE "^(200|401)$"; then
                echo "Backend ready after $((i * 3))s (HTTP $HTTP_CODE)"
                BACKEND_READY=true
                break
              fi
              sleep 3
            done
            if [ "$BACKEND_READY" = false ]; then
              echo "WARNING: backend not responding after 120s (last HTTP $HTTP_CODE)"
              echo "Containers are running — backend may still be starting up."
            fi

            echo "=== Health check ==="
            # Verify both containers are running
            docker ps --filter "name=noobbook-backend" --format "{{.Names}}" | grep -q "noobbook-backend" || { echo "FAIL: backend not running"; exit 1; }
            docker ps --filter "name=noobbook-frontend" --format "{{.Names}}" | grep -q "noobbook-frontend" || { echo "FAIL: frontend not running"; exit 1; }

            echo "=== Verifying deployed code ==="
            # Confirm the container has the exact commit we just built
            CONTAINER_SHA=$(docker exec noobbook-backend cat /app/.deploy_sha 2>/dev/null || echo "none")
            if [ "$CONTAINER_SHA" != "$LOCAL_SHA" ]; then
              echo "FAIL: container has stale code (container=$CONTAINER_SHA, expected=$LOCAL_SHA)"
              exit 1
            fi
            echo "Container verified at $CONTAINER_SHA"

            echo "=== Cleaning up old images ==="
            docker image prune -f

            echo "=== Deploy complete ==="
